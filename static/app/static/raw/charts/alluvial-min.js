!function(){var t=raw.models.graph(),n=raw.chart().title("桑基图").description("桑基图（Sankey diagram），即桑基能量分流图，也叫桑基能量平衡图。它是一种特定类型的流程图，图中延伸的分支的宽度对应数据流量的大小，通常应用于能源、材料成分、金融等数据的可视化分析。最明显的特征就是，始末端的分支宽度总各相等，即所有主支宽度的总和应与所有分出去的分支宽度的总和相等，保持能量的平衡。<a href='http://bost.ocks.org/mike/sankey/'>http://bost.ocks.org/mike/sankey/</a>").thumbnail("/static/raw/imgs/alluvial.png").category("复合分类").model(t),e=n.number().title("宽度").defaultValue(1e3).fitToWidth(!0),r=n.number().title("高度").defaultValue(500),a=n.number().title("节点宽度").defaultValue(5),o=n.list().title("排序").values(["size","name","automatic"]).defaultValue("size"),i=n.color().title("配色");n.draw(function(t,n){var u=d3.format(",.0f"),d=function(t){return u(t)},l=t.attr("width",+e()).attr("height",+r()+20).append("g").attr("transform","translate(0,10)"),s=d3.nest().key(function(t){return t.group}).rollup(function(t){return t.length}).entries(n.nodes),c=d3.max(s,function(t){return t.values}),f=d3.sankey().nodeWidth(+a()).nodePadding(d3.min([10,(r()-c)/c])).size([+e(),+r()]),y=f.link(),m=n.nodes,p=n.links;f.nodes(m).links(p).layout(32),s=d3.nest().key(function(t){return t.group}).map(m),d3.values(s).forEach(function(t){var n=(r()-d3.sum(t,function(t){return t.dy+f.nodePadding()}))/2+f.nodePadding()/2;t.sort(function(t,n){return"automatic"==o()?n.y-t.y:"size"==o()?n.dy-t.dy:"name"==o()?t.name<n.name?-1:t.name>n.name?1:0:void 0}),t.forEach(function(t){t.y=n,n+=t.dy+f.nodePadding()})}),d3.values(s).forEach(function(t){t.forEach(function(t){var n=0;t.sourceLinks.sort(function(t,n){return t.target.y-n.target.y}).forEach(function(t){t.sy=n,n+=t.dy}),n=0,t.targetLinks.sort(function(t,n){return t.source.y-n.source.y}).forEach(function(t){t.ty=n,n+=t.dy})})}),i.domain(p,function(t){return t.source.name});var h=l.append("g").selectAll(".link").data(p).enter().append("path").attr("class","link").attr("d",y).style("stroke-width",function(t){return Math.max(1,t.dy)}).style("fill","none").style("stroke",function(t){return i()(t.source.name)}).style("stroke-opacity",".4").sort(function(t,n){return n.dy-t.dy}).append("title").text(function(t){return console.log(t),t.value}),g=l.append("g").selectAll(".node").data(m).enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"});g.append("rect").attr("height",function(t){return t.dy}).attr("width",f.nodeWidth()).style("fill",function(t){return t.sourceLinks.length?i(t.name):"#666"}).append("title").text(function(t){return t.name+"\n"+d(t.value)}),g.append("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.name}).style("font-size","11px").style("font-family","Arial, Helvetica").style("pointer-events","none").filter(function(t){return t.x<+e()/2}).attr("x",6+f.nodeWidth()).attr("text-anchor","start")})}();